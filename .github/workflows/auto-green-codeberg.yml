# .github/workflows/auto-green-codeberg.yml
name: Auto-Green -> Codeberg (HTTPS + PAT)

# 定时运行（UTC），这里示例每天 00:30 UTC (你可以改 cron)
on:
  schedule:
    - cron: '30 0 * * *'
  workflow_dispatch: # 手动触发也允许

jobs:
  push-to-codeberg:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up git user
        run: |
          # 配置 commit 作者信息
          git config --global user.name "lanticy"
          git config --global user.email "lanticy@noreply.codeberg.org"

      - name: Prepare changes
        run: |
          # 示例：把当前 UTC 日期写入 update.txt（每次变化会导致 commit）
          mkdir -p auto-green
          date -u >> auto-green/update.txt
          git add auto-green/update.txt || true
          # 只有当有变动时才 commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Auto-green: `date -u +'%Y-%m-%d %H:%M:%S'`"

      - name: Push to Codeberg via HTTPS using token
        env:
          CODEBERG_TOKEN: ${{ secrets.CODEBERG_TOKEN }}   # 在 GitHub secrets 中设置
          CODEBERG_REPO: ${{ secrets.CODEBERG_REPO }}     # e.g. https://codeberg.org/username/repo.git
        run: |
          # 将远程设置为包含 token 的 URL（注意：token 出现在运行日志中可能会被 actions mask）
          if [ -z "$CODEBERG_REPO" ]; then
            echo "ERROR: CODEBERG_REPO secret is not set (e.g. https://codeberg.org/username/repo.git)"
            exit 1
          fi
          # 把 https://codeberg.org/username/repo.git -> https://<token>@codeberg.org/username/repo.git
          # 注意：有时需要对 token 做 URL-encoding（若包含特殊字符），建议使用無特殊字符的 token
          AUTHED_URL=$(echo "$CODEBERG_REPO" | sed -E "s#https://#https://$CODEBERG_TOKEN@#")
          # 若远程 origin 已存在（来自 actions/checkout），我们改名并 push
          git remote get-url origin || true
          git remote add codeberg "$AUTHED_URL" || git remote set-url codeberg "$AUTHED_URL"
          # 尝试 push 到默认分支（HEAD:refs/heads/main 视仓库默认分支而定）
          # 推荐把分支名改为你的 Codeberg 默认分支，如 main 或 master
          TARGET_BRANCH=main
          # 如果你的 repo 的默认分支不是 main，请改为 master 或其他
          git push codeberg HEAD:refs/heads/$TARGET_BRANCH --follow-tags --force
